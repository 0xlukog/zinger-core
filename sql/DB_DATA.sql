insert into users(mobile, oauth_id, notif_token, role) values('sfdbgffed','sfdbgffed','["token_sfdbgffed"]','SUPER_ADMIN');

insert into place values(1,'SSN College of Engineering','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Kelambakkam',0);
insert into place values(2,'VIT University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Vandaloor',0);
insert into place values(3,'SRM University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Ramapuram',0);
insert into place values(4,'SVCE University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Kelambakkam',0);
insert into place values(5,'SSN University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Vandaloor',0);
insert into place values(6,'IBM University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Ramapuram',0);
insert into place values(7,'HCL University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Vandaloor',0);
insert into place values(8,'Vidya University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Ramapuram',0);
insert into place values(9,'Accolite University','https://www.foodiesfeed.com/wp-content/uploads/2019/04/mae-mu-oranges-ice-349x436.jpg','Ramapuram',0);

insert into shop values(1,'Sathyas (Main)','shop.com','["shop.com","shop.com","shop.com"]',9176019344,1,'09:00:00','21:00:00',0);
insert into shop values(2,'Snow Qube','shop.com','["shop.com","shop.com","shop.com"]',9176019344,1,'09:00:00','21:00:00',0);
insert into shop values(3,'Sathyas PG','shop.com','["shop.com","shop.com","shop.com"]',9176019344,1,'09:00:00','21:00:00',0);

insert into shop values(4,'VIT Sathyas (Main)','shop.com','["shop.com","shop.com","shop.com"]',9176019344,2,'09:00:00','21:00:00',0);
insert into shop values(5,'VIT Snow Qube','shop.com','["shop.com","shop.com","shop.com"]',9176019344,2,'09:00:00','21:00:00',0);
insert into shop values(6,'VIT Sathyas PG','shop.com','["shop.com","shop.com","shop.com"]',9176019344,2,'09:00:00','21:00:00',0);

insert into shop values(7,'SRM Sathyas (Main)','shop.com','["shop.com","shop.com","shop.com"]',9176019344,3,'09:00:00','21:00:00',0);
insert into shop values(8,'SRM Snow Qube','shop.com','["shop.com","shop.com","shop.com"]',9176019344,3,'09:00:00','21:00:00',0);
insert into shop values(9,'SRM Sathyas PG','shop.com','["shop.com","shop.com","shop.com"]',9176019344,3,'09:00:00','21:00:00',0);

insert into item values(1,'Chicken Fried Rice',75,'food.com','CHINESE',1,0,1,0);
insert into item values(2,'Chicken Noodles',65,'food.com','CHINESE',1,0,1,0);
insert into item values(3,'Sada Dosa',35,'food.com','SOUTH INDIAN',1,1,1,0);
insert into item values(4,'Idly',30,'food.com','SOUTH INDIAN',1,1,1,0);
insert into item values(5,'Masala Dosa',45,'food.com','SOUTH INDIAN',1,1,1,0);
insert into item values(6,'Watermelon Juice',25,'food.com','BEVERAGES',1,1,1,0);
insert into item values(7,'Parota',75,'food.com','SOUTH INDIAN',1,1,1,0);
insert into item values(8,'Chappati (2)',55,'food.com','NORTH INDIAN',1,1,1,0);
insert into item values(9,'Samosa',10,'food.com','SNACKS',1,1,1,0);
insert into item values(10,'Pongal',45,'food.com','SOUTH INDIAN',1,1,1,0);
insert into item values(11,'Chicken 65',85,'food.com','SOUTH INDIAN',1,0,1,0);
insert into item values(12,'Chicken Biriyani',75,'food.com','SOUTH INDIAN',1,0,1,0);
insert into item values(13,'Apple Juice',35,'food.com','BEVERAGES',1,1,1,0);
insert into item values(14,'Grape Juice',25,'food.com','BEVERAGES',1,1,1,0);
insert into item values(15,'Mango Juice',45,'food.com','BEVERAGES',1,1,1,0);
insert into item values(16,'Mutton Biriyani',95,'food.com','SOUTH INDIAN',1,0,1,0);
insert into item values(17,'Chicken Fried Rice',75,'food.com','CHINESE',2,0,1,0);
insert into item values(18,'Chicken Noodles',65,'food.com','CHINESE',2,0,1,0);
insert into item values(19,'Sada Dosa',35,'food.com','SOUTH INDIAN',2,1,1,0);
insert into item values(20,'Idly',30,'food.com','SOUTH INDIAN',2,1,1,0);
insert into item values(21,'Masala Dosa',45,'food.com','SOUTH INDIAN',2,1,1,0);
insert into item values(22,'Watermelon Juice',25,'food.com','BEVERAGES',2,1,1,0);
insert into item values(23,'Parota',75,'food.com','SOUTH INDIAN',2,1,1,0);
insert into item values(24,'Chappati (2)',55,'food.com','NORTH INDIAN',3,1,1,0);
insert into item values(25,'Samosa',10,'food.com','SNACKS',3,1,1,0);
insert into item values(26,'Pongal',45,'food.com','SOUTH INDIAN',3,1,1,0);
insert into item values(27,'Chicken 65',85,'food.com','SOUTH INDIAN',4,0,1,0);
insert into item values(28,'Chicken Biriyani',75,'food.com','SOUTH INDIAN',4,0,1,0);
insert into item values(29,'Apple Juice',35,'food.com','BEVERAGES',4,1,1,0);
insert into item values(30,'Grape Juice',25,'food.com','BEVERAGES',5,1,1,0);
insert into item values(31,'Mango Juice',45,'food.com','BEVERAGES',5,1,1,0);
insert into item values(32,'Mutton Biriyani',95,'food.com','SOUTH INDIAN',6,0,1,0);
insert into item values(33,'Chappati (2)',55,'food.com','NORTH INDIAN',7,1,1,0);
insert into item values(34,'Samosa',10,'food.com','SNACKS',8,1,1,0);
insert into item values(35,'Pongal',45,'food.com','SOUTH INDIAN',9,1,1,0);
insert into item values(36,'Chicken 65',85,'food.com','SOUTH INDIAN',7,0,1,0);
insert into item values(37,'Chicken Biriyani',75,'food.com','SOUTH INDIAN',8,0,1,0);
insert into item values(38,'Apple Juice',35,'food.com','BEVERAGES',9,1,1,0);
insert into item values(39,'Grape Juice',25,'food.com','BEVERAGES',7,1,1,0);
insert into item values(40,'Mango Juice',45,'food.com','BEVERAGES',8,1,1,0);
insert into item values(41,'Mutton Biriyani',95,'food.com','SOUTH INDIAN',9,0,1,0);

insert into configurations(shop_id, delivery_price, merchant_id) values(1, 15.0, 'MID');
insert into configurations(shop_id, delivery_price, merchant_id) values(2, 10.0, 'MID');
insert into configurations(shop_id, delivery_price, merchant_id) values(3, 25.0, 'MID');

insert into configurations(shop_id, delivery_price, merchant_id) values(4, 15.0, 'MID');
insert into configurations(shop_id, delivery_price, merchant_id) values(5, 10.0, 'MID');
insert into configurations(shop_id, delivery_price, merchant_id) values(6, 25.0, 'MID');

insert into configurations(shop_id, delivery_price, merchant_id) values(7, 15.0, 'MID');
insert into configurations(shop_id, delivery_price, merchant_id) values(8, 10.0, 'MID');
insert into configurations(shop_id, delivery_price, merchant_id) values(9, 25.0, 'MID');

-- insert into transactions (transaction_id,order_id,bank_transaction_id,currency,response_code,response_message,gateway_name,bank_name,
-- payment_mode,checksum_hash) values("1","O00011","dsfs","RS","01","success","STRIPE","DBS","UPI","3232");

-- insert into transactions (transaction_id,order_id,bank_transaction_id,currency,response_code,response_message,gateway_name,bank_name,
-- payment_mode,checksum_hash) values("2","2","dsfs","RS","01","success","STRIPE","DBS","UPI","3232");

-- insert into transactions (transaction_id,order_id,bank_transaction_id,currency,response_code,response_message,gateway_name,bank_name,
-- payment_mode,checksum_hash) values("3","O00012","dsfs","RS","01","success","STRIPE","DBS","UPI","3232");

select * from users;
select * from place;
select * from place_log;
select * from shop;
select * from item;
select * from users_place;
select * from users_shop;
select * from users_invite;
select * from transactions;
select * from orders;
select * from orders_item;
select * from rating;
select * from configurations;


select SUM(oi.quantity*i.price)+(select IFNULL(SUM(c.delivery_price), 0)
								 from configurations as c
								 inner join orders as o 
                                 on o.shop_id=c.shop_id and 
                                 c.is_delivery_available=(SELECT IF(o.delivery_location is NULL,-1,1)) and o.id=4)  as TOTAL
from orders_item as oi
inner join item as i
on oi.item_id = i.id and oi.order_id=4;



select o.id,t.id,oi.*
from orders as o
inner join 
transactions as t
on o.id=t.order_id and o.user_id=3
inner join 
orders_item as oi
on oi.order_id=o.id;

select SUM(oi.quantity * i.price) +
(select IFNULL(SUM(c.delivery_price), 0)
from configurations as c
inner join orders as o
on o.shop_id = c.shop_id and
c.is_delivery_available =
(SELECT IF(o.delivery_location is NULL, -1, 1)) and
o.id = 1) as TOTAL
from orders_item as oi
inner join item as i
on oi.item_id = i.id and
oi.order_id = 1;


-- -1 -> order not taken
-- -2 -> delivery not available
-- 0 or actual_delivery_price
DROP PROCEDURE GetDeliveryPrice;
DELIMITER $$
CREATE PROCEDURE GetDeliveryPrice(
IN s_id INT,
IN order_type char,
OUT d_price INT 
)
BEGIN
DECLARE actual_delivery_price DOUBLE;
DECLARE actual_is_delivery_available INT;
DECLARE actual_is_order_taken INT;
DECLARE actual_shop_id INT;
DECLARE order_type CHAR;

SELECT c.delivery_price,c.is_delivery_available,c.is_order_taken
into actual_delivery_price,actual_is_delivery_available,actual_is_order_taken
from configurations as c
where c.shop_id=s_id;

IF actual_is_order_taken = 0 THEN
	set d_price = -1;
ELSE 
	IF order_type = 'D' THEN
		IF actual_is_delivery_available=1  THEN
			set d_price = actual_delivery_price;
		ELSE 
			set d_price =-2;
		END IF;
	ELSE 
		set d_price = 0;
	END IF;    
END IF;

END$$
DELIMITER ;

call GetDeliveryPrice(3,@delivery_price);
select @delivery_price;


DROP PROCEDURE calculatePrice;
DELIMITER $$  
CREATE PROCEDURE calculatePrice(
IN item_list json,
OUT total_price INT)  
BEGIN  
   
	DECLARE item_length BIGINT UNSIGNED DEFAULT JSON_LENGTH(item_list);
	DECLARE item_index BIGINT UNSIGNED DEFAULT 0;
    DECLARE item_id INT DEFAULT 0;
    DECLARE item_quantity INT DEFAULT 0;
    DECLARE item_price INT;
    set total_price = 0;
    
	item_loop:
    WHILE item_index < item_length DO
     set item_quantity = JSON_EXTRACT(item_list,CONCAT('$[', item_index, '].quantity'));
     set item_id = JSON_EXTRACT(item_list,CONCAT('$[', item_index, '].itemId'));
     
     set item_price = null;
     
     select price 
     into item_price
     from item
     where item.id = item_id and item.is_available=1 and item.is_delete=0;
     
     if(item_price is null ) then
		   set total_price = -3;
           LEAVE item_loop;
	 end if;
     
     set total_price = total_price + (item_price*item_quantity);
	 SET item_index = item_index + 1;
	END WHILE item_loop;
    
END$$;  
DELIMITER ;


call calculatePrice('[{"itemId":1,"quantity":1},{"itemId":2,"quantity":2},{"itemId":3,"quantity":2}]',@total_price);
select @total_price;

select * from item order by id;



